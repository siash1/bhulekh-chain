# BhulekhChain Development Environment
# Usage: docker compose -f docker-compose.dev.yaml up -d

services:
  # ============ FABRIC NETWORK ============

  orderer.bhulekhchain.dev:
    image: hyperledger/fabric-orderer:2.5
    container_name: orderer.bhulekhchain.dev
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_LISTENPORT=7050
      - ORDERER_GENERAL_BOOTSTRAPMETHOD=file
      - ORDERER_GENERAL_BOOTSTRAPFILE=/var/hyperledger/orderer/orderer.genesis.block
      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_CLUSTER_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_OPERATIONS_LISTENADDRESS=0.0.0.0:8443
      - ORDERER_METRICS_PROVIDER=prometheus
    ports:
      - "7050:7050"
      - "8443:8443"
    volumes:
      - ../../blockchain/fabric/network/channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block
      - ../../blockchain/fabric/network/crypto-material/ordererOrganizations/orderer.bhulekhchain.dev/orderers/orderer0.orderer.bhulekhchain.dev/msp:/var/hyperledger/orderer/msp
      - ../../blockchain/fabric/network/crypto-material/ordererOrganizations/orderer.bhulekhchain.dev/orderers/orderer0.orderer.bhulekhchain.dev/tls:/var/hyperledger/orderer/tls
    networks:
      bhulekh-net:
        aliases:
          - orderer0.orderer.bhulekhchain.dev

  peer0.revenue.bhulekhchain.dev:
    image: hyperledger/fabric-peer:2.5
    container_name: peer0.revenue.bhulekhchain.dev
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_ID=peer0.revenue.bhulekhchain.dev
      - CORE_PEER_ADDRESS=peer0.revenue.bhulekhchain.dev:7051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:7051
      - CORE_PEER_CHAINCODEADDRESS=peer0.revenue.bhulekhchain.dev:7052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.revenue.bhulekhchain.dev:7051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.revenue.bhulekhchain.dev:7051
      - CORE_PEER_LOCALMSPID=RevenueOrgMSP
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/msp
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb.revenue:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=adminpw
      - CORE_OPERATIONS_LISTENADDRESS=0.0.0.0:9444
      - CORE_METRICS_PROVIDER=prometheus
    ports:
      - "7051:7051"
      - "9444:9444"
    volumes:
      - ../../blockchain/fabric/network/crypto-material/peerOrganizations/revenue.bhulekhchain.dev/peers/peer0.revenue.bhulekhchain.dev/msp:/etc/hyperledger/fabric/msp
      - ../../blockchain/fabric/network/crypto-material/peerOrganizations/revenue.bhulekhchain.dev/peers/peer0.revenue.bhulekhchain.dev/tls:/etc/hyperledger/fabric/tls
    depends_on:
      - orderer.bhulekhchain.dev
      - couchdb.revenue
    networks:
      - bhulekh-net

  peer0.bank.bhulekhchain.dev:
    image: hyperledger/fabric-peer:2.5
    container_name: peer0.bank.bhulekhchain.dev
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_ID=peer0.bank.bhulekhchain.dev
      - CORE_PEER_ADDRESS=peer0.bank.bhulekhchain.dev:9051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:9051
      - CORE_PEER_CHAINCODEADDRESS=peer0.bank.bhulekhchain.dev:9052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:9052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.bank.bhulekhchain.dev:9051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.bank.bhulekhchain.dev:9051
      - CORE_PEER_LOCALMSPID=BankOrgMSP
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/msp
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb.bank:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=adminpw
      - CORE_OPERATIONS_LISTENADDRESS=0.0.0.0:9445
      - CORE_METRICS_PROVIDER=prometheus
    ports:
      - "9051:9051"
      - "9445:9445"
    volumes:
      - ../../blockchain/fabric/network/crypto-material/peerOrganizations/bank.bhulekhchain.dev/peers/peer0.bank.bhulekhchain.dev/msp:/etc/hyperledger/fabric/msp
      - ../../blockchain/fabric/network/crypto-material/peerOrganizations/bank.bhulekhchain.dev/peers/peer0.bank.bhulekhchain.dev/tls:/etc/hyperledger/fabric/tls
    depends_on:
      - orderer.bhulekhchain.dev
      - couchdb.bank
    networks:
      - bhulekh-net

  cc-land-registry.bhulekhchain.dev:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.chaincode
      args:
        CC_NAME: land-registry
    container_name: cc-land-registry.bhulekhchain.dev
    environment:
      - CHAINCODE_SERVER_ADDRESS=0.0.0.0:9999
      - CORE_CHAINCODE_ID_NAME=${CC_LAND_REGISTRY_PACKAGE_ID:-land-registry_1.0:placeholder}
    networks:
      bhulekh-net:
        aliases:
          - cc-land-registry.bhulekhchain.dev

  couchdb.revenue:
    image: couchdb:3.3
    container_name: couchdb.revenue
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - "5984:5984"
    networks:
      - bhulekh-net

  couchdb.bank:
    image: couchdb:3.3
    container_name: couchdb.bank
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - "7984:5984"
    networks:
      - bhulekh-net

  fabric-ca.revenue:
    image: hyperledger/fabric-ca:1.5
    container_name: fabric-ca.revenue
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca-revenue
      - FABRIC_CA_SERVER_PORT=7054
      - FABRIC_CA_SERVER_TLS_ENABLED=false
      - FABRIC_CA_SERVER_CA_CERTFILE=/etc/hyperledger/fabric-ca-server-config/ca.revenue.bhulekhchain.dev-cert.pem
      - FABRIC_CA_SERVER_CA_KEYFILE=/etc/hyperledger/fabric-ca-server-config/priv_sk
      - FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS=0.0.0.0:17054
    ports:
      - "7054:7054"
      - "17054:17054"
    command: sh -c 'fabric-ca-server start -b admin:adminpw -d'
    volumes:
      - ../../blockchain/fabric/network/crypto-material/peerOrganizations/revenue.bhulekhchain.dev/ca:/etc/hyperledger/fabric-ca-server-config
    networks:
      - bhulekh-net

  fabric-ca.bank:
    image: hyperledger/fabric-ca:1.5
    container_name: fabric-ca.bank
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca-bank
      - FABRIC_CA_SERVER_PORT=7054
      - FABRIC_CA_SERVER_TLS_ENABLED=false
      - FABRIC_CA_SERVER_CA_CERTFILE=/etc/hyperledger/fabric-ca-server-config/ca.bank.bhulekhchain.dev-cert.pem
      - FABRIC_CA_SERVER_CA_KEYFILE=/etc/hyperledger/fabric-ca-server-config/priv_sk
      - FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS=0.0.0.0:17054
    ports:
      - "8054:7054"
      - "18054:17054"
    command: sh -c 'fabric-ca-server start -b admin:adminpw -d'
    volumes:
      - ../../blockchain/fabric/network/crypto-material/peerOrganizations/bank.bhulekhchain.dev/ca:/etc/hyperledger/fabric-ca-server-config
    networks:
      - bhulekh-net

  # ============ DATA LAYER ============

  postgres:
    image: postgis/postgis:16-3.4
    container_name: bhulekh-postgres
    environment:
      POSTGRES_DB: bhulekhchain
      POSTGRES_USER: bhulekh
      POSTGRES_PASSWORD: devpassword
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bhulekh -d bhulekhchain"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bhulekh-net

  redis:
    image: redis:7-alpine
    container_name: bhulekh-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - bhulekh-net

  ipfs:
    image: ipfs/kubo:latest
    container_name: bhulekh-ipfs
    ports:
      - "4001:4001"
      - "5001:5001"
      - "8081:8080"
    volumes:
      - ipfsdata:/data/ipfs
    environment:
      - IPFS_PROFILE=server
    networks:
      - bhulekh-net

  # ============ MONITORING ============

  explorer:
    image: hyperledger/explorer:latest
    container_name: bhulekh-explorer
    environment:
      - DATABASE_HOST=explorerdb
      - DATABASE_PORT=5432
      - DATABASE_DATABASE=fabricexplorer
      - DATABASE_USERNAME=hppoc
      - DATABASE_PASSWD=password
      - LOG_LEVEL_APP=info
      - LOG_LEVEL_DB=info
      - LOG_LEVEL_CONSOLE=debug
      - LOG_CONSOLE_STDOUT=true
      - DISCOVERY_AS_LOCALHOST=true
    ports:
      - "8080:8080"
    volumes:
      - ../../blockchain/fabric/network/crypto-material:/tmp/crypto
    depends_on:
      explorerdb:
        condition: service_healthy
      peer0.revenue.bhulekhchain.dev:
        condition: service_started
    networks:
      - bhulekh-net

  explorerdb:
    image: hyperledger/explorer-db:latest
    container_name: bhulekh-explorerdb
    environment:
      - DATABASE_DATABASE=fabricexplorer
      - DATABASE_USERNAME=hppoc
      - DATABASE_PASSWD=password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hppoc -d fabricexplorer"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bhulekh-net

  prometheus:
    image: prom/prometheus:latest
    container_name: bhulekh-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    depends_on:
      - redis
      - postgres
    networks:
      - bhulekh-net

  grafana:
    image: grafana/grafana:latest
    container_name: bhulekh-grafana
    ports:
      - "3002:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    depends_on:
      - prometheus
    networks:
      - bhulekh-net

  # ============ AUTH ============

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: bhulekh-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/bhulekhchain
      KC_DB_USERNAME: bhulekh
      KC_DB_PASSWORD: devpassword
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    command: start-dev
    ports:
      - "8180:8080"
      - "8543:8443"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - bhulekh-net

volumes:
  pgdata:
    driver: local
  ipfsdata:
    driver: local

networks:
  bhulekh-net:
    name: bhulekh-net
    driver: bridge
